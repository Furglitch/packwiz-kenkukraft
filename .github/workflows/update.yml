name: Update Modlist

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: '0 6 */3 * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Pull existing PR branch
        id: check_branch
        run: |
          # Configure git identity for merge
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          if git ls-remote --heads origin update-mods | grep -q update-mods; then
            echo "exists=true" >> $GITHUB_OUTPUT
            git fetch origin update-mods

            if git merge -X theirs --no-edit origin/update-mods; then
              echo "Merged origin/update-mods (preferred incoming changes)"
            else
              echo "Merge produced conflicts — auto-resolving by taking incoming changes..."
              git ls-files -u | awk '{print $4}' | sort -u | while read -r f; do
                git checkout --theirs -- "$f" || true
                git add "$f" || true
              done
              git commit -m "Merge origin/update-mods (auto-resolved conflicts preferring incoming changes)" || true
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # - name: Pull existing PR branch
      #   id: check_branch_local
      #   run: |
      #     # Configure git identity for merge
      #     git config --global user.email "github-actions[bot]@users.noreply.github.com"
      #     git config --global user.name "github-actions[bot]"

      #     if git ls-remote --heads origin main | grep -q main; then
      #       echo "exists=true" >> $GITHUB_OUTPUT
      #       git fetch origin main
      #       git merge origin/main --no-edit || echo "Merge conflict or no changes to merge"
      #     else
      #       echo "exists=false" >> $GITHUB_OUTPUT
      #     fi

      - name: Download packwiz artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: go.yml
          repo: packwiz/packwiz
          name: Linux 64-bit x86
          path: ./packwiz-bin

      - name: Setup packwiz
        run: |
          chmod +x ./packwiz-bin/packwiz
          sudo mv ./packwiz-bin/packwiz /usr/local/bin/
        
      - name: Refresh modpack
        working-directory: ./packwiz
        run: packwiz refresh

      - name: Update mods
        working-directory: ./packwiz
        run: packwiz update --all --yes | tee /tmp/packwiz_update.out

      - name: Parse updates and build PR body
        id: parse_updates
        run: |
          cat > /tmp/extract_version.sh <<'EXTRACT_SCRIPT'
          #!/bin/bash

          extract_version() {
            local filename="$1"
            local version=""
            local cleaned="$filename"

            cleaned=$(echo "$cleaned" | sed -E 's/\.(jar|zip)$//')

            cleaned="${cleaned//-signed/}"
            cleaned="${cleaned//-all/}"
            cleaned="${cleaned//-universal/}"
            cleaned="${cleaned//-dev/}"
            cleaned="${cleaned//-api/}"
            cleaned="${cleaned//-lib/}"
            cleaned="${cleaned//-snapshot/}"
            cleaned="${cleaned//-FINAL/}"
            cleaned="${cleaned//-hotfix/}"
            cleaned="${cleaned//-patch/}"

            cleaned=$(echo "$cleaned" | sed -E 's/-[0-9]{1,2}\.[0-9]{1,2}\.[0-9]{4}//g')

            cleaned="${cleaned//-neoforge/}"
            cleaned="${cleaned//-forge/}"
            cleaned="${cleaned//-fabric/}"
            cleaned="${cleaned//-quilt/}"
            cleaned="${cleaned//_neoforge/}"
            cleaned="${cleaned//_forge/}"
            cleaned="${cleaned//_fabric/}"
            cleaned="${cleaned//_quilt/}"

            cleaned=$(echo "$cleaned" | sed -E 's/^[a-zA-Z_-]+//')

            cleaned=$(echo "$cleaned" | sed -E 's/^mc1\.[0-9]+(\.[0-9]+)?[-_]//')
            cleaned=$(echo "$cleaned" | sed -E 's/\+minecraft-1\.[0-9]+(\.[0-9]+)?//g')
            cleaned=$(echo "$cleaned" | sed -E 's/\+mc1\.[0-9]+(\.[0-9]+)?//g')
            cleaned=$(echo "$cleaned" | sed -E 's/[-_]mc1\.[0-9]+(\.[0-9]+)?//g')
            cleaned=$(echo "$cleaned" | sed -E 's/[-_]minecraft1\.[0-9]+(\.[0-9]+)?//g')
            cleaned=$(echo "$cleaned" | sed -E 's/-minecraft-1\.[0-9]+(\.[0-9]+)?//g')
            cleaned=$(echo "$cleaned" | sed -E 's/^1\.(1[0-9]|20|21)(\.[0-9]+)?[-_]//')
            cleaned=$(echo "$cleaned" | sed -E 's/[-_]1\.(1[0-9]|20|21)(\.[0-9]+)?$//')
            cleaned=$(echo "$cleaned" | sed -E 's/-v1\.(1[0-9]|20|21)(\.[0-9]+)?[-_]//')
            cleaned=$(echo "$cleaned" | sed -E 's/-for-1\.[0-9]+(\.[0-9]+)?//g')

            cleaned="${cleaned//minecraft-/}"
            cleaned="${cleaned//-minecraft/}"
            cleaned="${cleaned//minecraft/}"
            cleaned="${cleaned//mc-/}"
            cleaned="${cleaned//-mc/}"

            cleaned=$(echo "$cleaned" | sed -E 's/\[[^]]*\]//g')
            cleaned=$(echo "$cleaned" | sed -E 's/^[_+.\-]+//')
            cleaned=$(echo "$cleaned" | sed -E 's/[_+.\-]+$//')

            cleaned=$(echo "$cleaned" | sed -E "s/[’']+//g" | sed -E 's/[[:space:]]+/ /g')

            if [[ "$cleaned" =~ ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+[a-z]?) ]]; then
              version="${BASH_REMATCH[1]}"
              echo "$version"
              return 0
            fi
            if [[ "$cleaned" =~ ([0-9]+\.[0-9]+\.[0-9]+[a-z]?) ]]; then
              version="${BASH_REMATCH[1]}"
              echo "$version"
              return 0
            fi
            if [[ "$cleaned" =~ ([0-9]+\.[0-9]+[a-z]?) ]]; then
              version="${BASH_REMATCH[1]}"
              echo "$version"
              return 0
            fi
            if [[ "$cleaned" =~ _v([0-9]+\.[0-9]+(\.[0-9]+)?(-[a-zA-Z]+\.[0-9]+[a-z]?)?(-[a-zA-Z]+\.[0-9]+)?) ]]; then
              version="${BASH_REMATCH[1]}"
              echo "$version"
              return 0
            fi
            if [[ "$cleaned" =~ -?[Vv]([0-9]+\.[0-9]+(\.[0-9]+)?) ]]; then
              version="${BASH_REMATCH[1]}"
              echo "$version"
              return 0
            fi
            if [[ "$cleaned" =~ ^([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+[a-z]?(-[a-zA-Z]+\.[0-9]+[a-z]?)?(-[a-zA-Z]+\.[0-9]+)?) ]]; then
              version="${BASH_REMATCH[1]}"
            elif [[ "$cleaned" =~ ^([0-9]+\.[0-9]+\.[0-9]+[a-z]?(-[a-zA-Z]+\.[0-9]+[a-z]?)?(-[a-zA-Z]+\.[0-9]+)?) ]]; then
              version="${BASH_REMATCH[1]}"
            elif [[ "$cleaned" =~ ^([0-9]+\.[0-9]+[a-z]?(-[a-zA-Z]+\.[0-9]+[a-z]?)?) ]]; then
              version="${BASH_REMATCH[1]}"
            elif [[ "$cleaned" =~ ^v([0-9]+\.[0-9]+(\.[0-9]+)?[a-z]?(-[a-zA-Z]+\.[0-9]+[a-z]?)?(-[a-zA-Z]+\.[0-9]+)?) ]]; then
              version="${BASH_REMATCH[1]}"
            fi

            echo "$filename -> $version" >&2
            echo "$version"
          }

          extract_version "$1"
          EXTRACT_SCRIPT

          chmod +x /tmp/extract_version.sh

            if [ ! -f "/tmp/packwiz_update.out" ]; then
            echo "## Updated:" > /tmp/pr_body.txt
            echo "No updates found (file not found)." >> /tmp/pr_body.txt
            else
            echo "## Updated:" > /tmp/pr_body.txt

            sed -n '/Updates found:/,/Do you want to update\? /p' "/tmp/packwiz_update.out" | \
            grep ' -> ' | \
            while IFS= read -r line; do
              mod_name=$(echo "$line" | sed -E 's/^[[:space:]]*(.*): .* -> .*/\1/')
              files=$(echo "$line" | sed -E 's/^.*: (.*)/\1/')
              old_file=$(echo "$files" | sed -E 's/(.*) -> .*/\1/')
              new_file=$(echo "$files" | sed -E 's/.* -> (.*)/\1/')

              mod_name=$(echo "$mod_name" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              old_file=$(echo "$old_file" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
              new_file=$(echo "$new_file" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

              old_version=$(/tmp/extract_version.sh "$old_file")
              new_version=$(/tmp/extract_version.sh "$new_file")

              if [ -n "$old_version" ] && [ -n "$new_version" ]; then
              echo "**${mod_name}:** ${old_version} ➜ ${new_version}"
              else
              echo "**${mod_name}:** ${old_file} ➜ ${new_file}"
              fi
            done | sort -f >> /tmp/pr_body.txt
            fi

            {
            echo "body<<EOF"
            cat /tmp/pr_body.txt
            echo "EOF"
            } >> $GITHUB_OUTPUT

      - name: Check if updates were found
        id: check_updates
        run: |
          if grep -q ' -> ' "/tmp/packwiz_update.out" 2>/dev/null; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates found, proceeding with PR creation/update"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates found, skipping PR steps"
          fi

      - name: Debug PR body output
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "${{ steps.parse_updates.outputs.body }}"

      - name: Check for existing PR and fetch body
        if: steps.check_updates.outputs.has_updates == 'true'
        id: check_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:update-mods`
            });
            
            if (pullRequests.length > 0) {
              core.setOutput('exists', 'true');
              core.setOutput('number', pullRequests[0].number);
              core.setOutput('existing_body', pullRequests[0].body || '');
              console.log(`Found existing PR #${pullRequests[0].number}`);
            } else {
              core.setOutput('exists', 'false');
              console.log('No existing PR found');
            }
      
      # - name: Check for existing PR (LOCAL TEST)
      #   id: check_pr_local
      #   if: steps.check_updates.outputs.has_updates == 'true'
      #   run: |
      #     echo "Would check for existing PR with head: update-mods"
      #     echo "exists=${{ steps.check_branch.outputs.exists }}" >> $GITHUB_OUTPUT
      #     echo "number=123" >> $GITHUB_OUTPUT
      
      - name: Prepare PR body
        if: steps.check_updates.outputs.has_updates == 'true'
        id: prepare_body
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            # PR exists, keep the existing body unchanged
            cat > /tmp/final_body.txt <<'EXISTING_BODY'
          ${{ steps.check_pr.outputs.existing_body }}
          EXISTING_BODY
          else
            # New PR, use the parsed body
            cat > /tmp/final_body.txt <<'NEW_BODY'
          ${{ steps.parse_updates.outputs.body }}
          NEW_BODY
          fi
          
          {
            echo "body<<EOF"
            cat /tmp/final_body.txt
            echo "EOF"
          } >> $GITHUB_OUTPUT
      
      # - name: Prepare PR body
      #   if: steps.check_updates.outputs.has_updates == 'true'
      #   id: prepare_body_local
      #   run: |
      #     if [ "${{ steps.check_pr_local.outputs.exists }}" == "true" ]; then
      #       # PR exists, keep the existing body unchanged
      #       cat > /tmp/final_body.txt <<'EXISTING_BODY'
      #     ${{ steps.check_pr_local.outputs.existing_body }}
      #     EXISTING_BODY
      #     else
      #       # New PR, use the parsed body
      #       cat > /tmp/final_body.txt <<'NEW_BODY'
      #     ${{ steps.parse_updates.outputs.body }}
      #     NEW_BODY
      #     fi
          
      #     {
      #       echo "body<<EOF"
      #       cat /tmp/final_body.txt
      #       echo "EOF"
      #     } >> $GITHUB_OUTPUT

      - name: Create or Update Pull Request
        id: cpr
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update mods'
          title: 'Update mods to latest versions'
          body: ${{ steps.prepare_body.outputs.body }}
          branch: update-mods
          delete-branch: false

      # - name: Create or Update Pull Request (LOCAL TEST)
      #   id: cpr_local
      #   if: steps.check_updates.outputs.has_updates == 'true'
      #   run: |
      #     if [ "${{ steps.check_branch.outputs.exists }}" == "true" ]; then
      #       echo "=== Would UPDATE existing PR #123 with: ==="
      #       echo "pull-request-operation=updated" >> $GITHUB_OUTPUT
      #     else
      #       echo "=== Would CREATE new PR with: ==="
      #       echo "pull-request-operation=created" >> $GITHUB_OUTPUT
      #     fi
      #     echo "Branch: update-mods"
      #     echo "Title: Update mods to latest versions"
      #     echo ""
      #     echo "Body:"
      #     echo "${{ steps.parse_updates.outputs.body }}"
      #     echo ""
      #     echo "pull-request-number=123" >> $GITHUB_OUTPUT

      - name: Comment on existing PR with new updates
        id: comment_pr
        if: steps.check_updates.outputs.has_updates == 'true' && steps.check_pr.outputs.exists == 'true' && steps.cpr.outputs.pull-request-operation == 'updated'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.check_pr.outputs.number }};
            const body = `## New Updates (${new Date().toISOString().split('T')[0]})\n\n${{ steps.parse_updates.outputs.body }}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      # - name: Comment on existing PR with new updates (LOCAL TEST)
      #   id: comment_pr_local
      #   if: steps.check_updates.outputs.has_updates == 'true' && steps.check_pr_local.outputs.exists == 'true' && steps.cpr_local.outputs.pull-request-operation == 'updated'
      #   run: |
      #     echo ""
      #     echo "=== Would post comment on PR #${{ steps.check_pr_local.outputs.number }}: ==="
      #     echo ""
      #     echo "## New Updates ($(date -I))"
      #     echo ""
      #     echo "${{ steps.parse_updates.outputs.body }}"