name: Build Modpack

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
        
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Download packwiz artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: go.yml
          repo: packwiz/packwiz
          name: Linux 64-bit x86
          path: ./packwiz-bin
        
      - name: Setup packwiz
        run: |
          chmod +x ./packwiz-bin/packwiz
          sudo mv ./packwiz-bin/packwiz /usr/local/bin/
      
      - name: Parse pack info
        id: pack_info
        run: |
          NAME=$(grep '^name = ' packwiz/pack.toml | cut -d '"' -f 2)
          VERSION=$(grep '^version = ' packwiz/pack.toml | cut -d '"' -f 2)
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        
      - name: Refresh modpack
        working-directory: ./packwiz
        run: packwiz refresh
      
      - name: Export client modpack
        working-directory: ./packwiz
        run: packwiz curseforge export --side client
      
      - name: Extract client modpack
        run: |
          mkdir -p modpack-client
          unzip packwiz/*.zip -d modpack-client
      
      - name: Upload client modpack artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.pack_info.outputs.name }}-${{ steps.pack_info.outputs.version }}-client
          path: modpack-client/

      - name: Build server modpack
        working-directory: ./packwiz
        run: |
          # Parse NeoForge version from pack.toml
          NEOFORGE_VERSION=$(grep '^neoforge = ' pack.toml | cut -d '"' -f 2)
          echo "NeoForge version: $NEOFORGE_VERSION"
          
          # Install packwiz-installer
          wget https://github.com/packwiz/packwiz-installer-bootstrap/releases/latest/download/packwiz-installer-bootstrap.jar
          
          # Create server directory structure
          mkdir -p ../modpack-server
          
          # Copy configs
          cp -r config ../modpack-server/
          
          # Copy server files (startup scripts, properties, icon)
          cp -r ../server/* ../modpack-server/
          
          # Replace NeoForge version in startup scripts
          sed -i "s/\\\$NEOFORGE_VERSION/${NEOFORGE_VERSION}/g" ../modpack-server/startserver.sh
          sed -i "s/%NEOFORGE_VERSION%/${NEOFORGE_VERSION}/g" ../modpack-server/startserver.bat
          
          # Download all mods using packwiz (first pass - collect excluded files)
          cd ../modpack-server
          echo "Running first pass to collect CurseForge-excluded files..."
          java -jar ../packwiz/packwiz-installer-bootstrap.jar -g -s server https://raw.githubusercontent.com/${{ github.repository }}/main/packwiz/pack.toml 2>&1 | tee install.log || true
          
          # Parse and download excluded files from CDN
          echo "Downloading CurseForge-excluded files from CDN..."
          grep "Please go to" install.log | while read -r line; do
            # Extract the CurseForge URL
            cf_url=$(echo "$line" | grep -oP 'https://www\.curseforge\.com[^ ]+')
            # Extract the file ID from the URL (e.g., /files/7403631 -> 7403631)
            file_id=$(echo "$cf_url" | grep -oP '/files/\K[0-9]+')
            # Extract the destination path
            dest_path=$(echo "$line" | grep -oP 'save this file to \K.+')
            
            if [ -n "$file_id" ] && [ -n "$dest_path" ]; then
              # Convert file ID to CDN URL format: edge.forgecdn.net/files/XXXX/YYY/filename
              # Split file_id into groups (e.g., 7403631 -> 7403/631)
              id_part1=$(echo "$file_id" | sed 's/\(.*\)\(...\)/\1/')
              id_part2=$(echo "$file_id" | sed 's/.*\(...\)/\1/')
              
              # Get filename from destination path
              filename=$(basename "$dest_path")
              
              # URL-encode the filename
              encoded_filename=$(echo "$filename" | sed 's/ /%20/g' | sed "s/'/%27/g")
              
              # Construct CDN URL
              cdn_url="https://edge.forgecdn.net/files/${id_part1}/${id_part2}/${encoded_filename}"
              
              echo "Downloading: $cdn_url -> $dest_path"
              mkdir -p "$(dirname "$dest_path")"
              wget -q "$cdn_url" -O "$dest_path" || echo "Failed to download $cdn_url"
            fi
          done
          
          # Run packwiz-installer again to complete installation
          echo "Running second pass to complete installation..."
          java -jar ../packwiz/packwiz-installer-bootstrap.jar -g -s server https://raw.githubusercontent.com/${{ github.repository }}/main/packwiz/pack.toml
          
          # Download and install NeoForge server
          echo "Downloading NeoForge server $NEOFORGE_VERSION..."
          wget https://maven.neoforged.net/releases/net/neoforged/neoforge/${NEOFORGE_VERSION}/neoforge-${NEOFORGE_VERSION}-installer.jar -O neoforge-$NEOFORGE_VERSION-installer.jar

      - name: Upload server modpack artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.pack_info.outputs.name }}-${{ steps.pack_info.outputs.version }}-server
          path: modpack-server/